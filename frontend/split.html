<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Split Bill | AlgoTrust</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/algosdk@2.4.0/dist/browser/algosdk.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F9FAFB; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- Header Navigation -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-slate-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="dashboard.html" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </a>
                <h1 class="text-xl font-bold text-slate-900">Expense Settlement</h1>
            </div>
            <div id="wallet-pill" class="bg-emerald-50 px-4 py-2 rounded-full border border-emerald-100 text-emerald-600 text-sm font-mono font-bold">
                Connecting...
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-6 mt-12">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            
            <!-- Left Side: Input Form -->
            <div class="space-y-8">
                <div>
                    <h2 class="text-3xl font-bold text-slate-900 mb-2">Split the Bill</h2>
                    <p class="text-slate-500">Simplify campus life. Split club dues or house expenses and settle instantly with colleagues.</p>
                </div>

                <div class="glass-card bg-white p-8 rounded-[32px] border border-white space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-tight">Group / Expense Name</label>
                        <input type="text" id="group-name" placeholder="e.g. Student House Electricity" class="w-full">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-tight">Total Amount (ALGO)</label>
                        <input type="number" id="total-amount" placeholder="0.00" class="w-full text-lg font-semibold text-indigo-600">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-tight">Participant Addresses (One per line)</label>
                        <textarea id="participants-list" rows="5" placeholder="ADDRESS1...&#10;ADDRESS2..." class="w-full font-mono text-xs"></textarea>
                        <p class="text-[11px] text-slate-400 mt-2">Maximum 15 participants allowed per settlement group.</p>
                    </div>

                    <button id="calculate-btn" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold hover:bg-slate-800 transition-all active:scale-[0.98]">
                        Calculate Split
                    </button>
                </div>
            </div>

            <!-- Right Side: Results & Settle -->
            <div id="result-section" class="hidden space-y-6">
                <div class="glass-card bg-white p-8 rounded-[32px] border border-white">
                    <h3 class="text-xl font-bold text-slate-900 mb-6">Settlement Summary</h3>
                    
                    <div id="split-list" class="space-y-4 mb-8">
                        <!-- Items injected by JS -->
                    </div>

                    <div class="pt-6 border-t border-slate-100 space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500 font-medium">Per Person Share</span>
                            <span id="share-display" class="text-xl font-extrabold text-slate-900">0.00 ALGO</span>
                        </div>
                        
                        <button id="settle-btn" class="btn-primary-ios w-full py-4 bg-emerald-600 text-white shadow-lg shadow-emerald-100 hover:bg-emerald-700">
                            Settle & Pay All
                        </button>
                        
                        <p class="text-[10px] text-slate-400 text-center uppercase font-bold tracking-widest">
                            Secure Atomic Group Transaction
                        </p>
                    </div>
                </div>

                <div class="p-6 bg-blue-50 rounded-[24px] border border-blue-100 flex items-start space-x-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-sm text-blue-700 leading-relaxed">
                        Settling will create an <strong>Atomic Transfer</strong>. This ensures either all participants are paid simultaneously, or none are, preventing partial payments.
                    </p>
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { SplitModule } from './js/modules/split.js';
        import { PeraWalletManager } from './js/wallet.js';
        import { truncateAddress } from './js/algorand.js';

        const peraManager = new PeraWalletManager();
        const address = localStorage.getItem('walletAddress');
        let currentParticipants = [];
        let currentTotal = 0;

        // Init UI
        if (address) {
            document.getElementById('wallet-pill').innerText = truncateAddress(address);
        }

        document.getElementById('calculate-btn').addEventListener('click', () => {
            const total = parseFloat(document.getElementById('total-amount').value);
            const listRaw = document.getElementById('participants-list').value;
            
            if (!total || total <= 0 || !listRaw) return alert("Please fill in all fields.");

            const splits = SplitModule.calculateSplits(total, listRaw);
            currentParticipants = splits.map(s => s.address);
            currentTotal = total;

            // Render Results
            const listEl = document.getElementById('split-list');
            listEl.innerHTML = '';
            
            splits.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100';
                div.innerHTML = `
                    <span class="text-xs font-mono text-slate-500">${truncateAddress(item.address)}</span>
                    <span class="text-sm font-bold text-slate-900">${item.share} ALGO</span>
                `;
                listEl.appendChild(div);
            });

            document.getElementById('share-display').innerText = `${splits[0].share} ALGO`;
            document.getElementById('result-section').classList.remove('hidden');
        });

        document.getElementById('settle-btn').addEventListener('click', async () => {
            const btn = document.getElementById('settle-btn');
            btn.disabled = true;
            btn.innerText = "Signing Group Tx...";

            try {
                await SplitModule.settleExpenses(address, currentTotal, currentParticipants, peraManager);
                alert("Settlement Successful! All participants paid.");
                window.location.href = 'dashboard.html';
            } catch (err) {
                console.error(err);
                alert("Settlement failed. Check balance or wallet connection.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Settle & Pay All";
            }
        });
    </script>
</body>
</html>